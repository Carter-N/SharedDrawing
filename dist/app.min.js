/*
 sww 2016-05-29 
*/
requirejs.config({paths:{jquery:"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-beta1/jquery.min",bootstrap:"http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min",spectrum:"https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.0/spectrum.min",io:"http://cdn.socket.io/socket.io-1.4.5",snap:"https://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.4.1/snap.svg-min",svgPanZoom:"https://cdnjs.cloudflare.com/ajax/libs/snap.svg.zpd/0.0.11/snap.svg.zpd.min"}}),requirejs(["jquery","board","io"],function(a,b,c){}),define("board",["jquery","brush","menu","collaboration","snap"],function(a,b,c,d,e){var f=a("#board");a(f).width(window.innerWidth),a(f).height(window.innerHeight);var g=Snap("#board");c.init(),b.init(g);var h={x:null,y:null,pressed:null,lastX:null,lastY:null},i=function(a){l.x=a.pageX,l.y=a.pageY,h.pressed=!0,m(a)},j=function(a){if("line"==c.tool.selected){var e=l.x,f=l.y,g=a.pageX,i=a.pageY;b.setColor(b.getColor()),b.line(e,f,g,i),d.line(e,f,g,i,b.getColor())}if("circle"==c.tool.selected){var j=l.x,k=l.y,n=Math.sqrt(Math.pow(a.pageX-j,2)+Math.pow(a.pageY-k,2));b.setColor(b.getColor()),b.circle(j,k,n),d.circle(j,k,n,b.getColor())}if("rectangle"==c.tool.selected){var j=l.x,k=l.y,o=Math.abs(a.pageX-l.x),p=Math.abs(a.pageY-l.y);b.setColor(b.getColor()),b.rectangle(j,k,o,p),d.rectangle(j,k,o,p,b.getColor())}h.pressed=!1,m(a)},k=function(a){m(a),h.pressed&&("pen"===c.tool.selected&&(b.setColor(b.getColor()),b.line(h.lastX,h.lastY,a.pageX,a.pageY),d.line(h.lastX,h.lastY,a.pageX,a.pageY,b.getColor())),"eraser"===c.tool.selected&&(d.socket.emit("erase",{x:h.x-50,y:h.y-50}),b.erase(h.x-50,h.y-50,100)))},l={x:0,y:0},m=function(a){h.lastX=h.x,h.lastY=h.y,h.x=a.pageX,h.y=a.pageY};return a(f).on("touchstart",function(a){a.pageX=a.changedTouches[0].pageX,a.pageY=a.changedTouches[0].pageY,i(a)}),a(f).on("mousedown",function(a){i(a)}),a(f).on("mouseup",function(a){j(a)}),a(f).on("touchend",function(a){a.pageX=a.changedTouches[0].pageX,a.pageY=a.changedTouches[0].pageY,j(a)}),a(f).on("touchmove",function(a){"board"===a.target.id&&a.preventDefault(),a.pageX=a.changedTouches[0].pageX,a.pageY=a.changedTouches[0].pageY,k(a)}),a(f).on("mousemove",function(a){k(a)}),{board:f,mouse:h}}),define("brush",["jquery","spectrum","snap"],function(a,b,c){var d=null,e=null,f=function(a){d=a},g=function(a){e=a},h=function(){var b=a("#picker").spectrum("get");return b.toRgbString()},i=function(a,b,c,f){var g=d.rect(a,b,c,f);g.attr({strokeWidth:2,stroke:e})},j=function(b,c,e){var f=a("#picker").spectrum("get"),g=d.circle(b,c,e);g.attr({strokeWidth:2,stroke:f.toRgbString()})},k=function(a,b,c,f){var g=d.line(a,b,c,f);g.attr({strokeWidth:2,stroke:e})};return{rectangle:i,init:f,color:e,setColor:g,getColor:h,line:k,circle:j}}),define("collaboration",["jquery","io","brush"],function(a,b,c){var d,e,f=b(),g=a("#collaborate"),h=a("#collaborate-menu"),i=a("#join"),j=a("#room-id"),k=a("#name"),l=a("#close"),m=a("#users");a(h).hide(),a(g).on("click",function(b){a(h).show()}),a(i).on("click",function(b){f.emit("join-room",{id:j.val(),name:k.val()}),a(h).hide()}),a(l).on("click",function(){a(h).hide()});var n=function(a,b,c,d,e){f.emit("action",{action:0,x1:a,y1:b,x2:c,y2:d,color:e})},o=function(a,b,c,d){f.emit("action",{action:1,x:a,y:b,r:c,color:d})},p=function(a,b,c,d,e){f.emit("action",{action:2,x:a,y:b,w:c,h:d,color:e})},q=function(b){a(m).empty(),console.log(b);for(var c in b)console.log(c),b[c].p?a(m).append("<div class='user' id="+c+">"+b[c].name+"<button class='perm granted' type='button'>p</button></div>"):a(m).append("<div class='user' id="+c+">"+b[c].name+"<button class='perm denied' type='button'>p</button></div>");a(".perm").on("click",function(a){var b=a.target.id;d.clients[b].p=!d.clients[b].p,f.emit("permissions-changed",d.clients),q(d.clients)})};f.on("join-room-sucess",function(a){r(a.board.actions),console.log("Joined board"),d=a.board,q(d.clients)}),f.on("permissions-changed",function(a){q(a)}),f.on("join-room-failed",function(){console.log("Failed to join board")}),f.on("id",function(b){a("#board-id").text(b.board.id),d=b.board,e=b.client,q(b.board.clients)}),f.on("client-joined",function(a){q(a)}),f.on("client-left",function(a){console.log("Client left"),q(a)}),f.on("action",function(a){s(a)}),f.on("erase",function(a){c.erase(a.x,a.y,100)});var r=function(a){for(var b=0;b<a.length;b++)s(a[b])},s=function(a){0===a.action&&(c.setColor(a.color),c.line(a.x1,a.y1,a.x2,a.y2)),1===a.action&&(c.setColor(a.color),c.circle(a.x,a.y,a.r)),2===a.action&&(c.setColor(a.color),c.rectangle(a.x,a.y,a.w,a.h))};return{socket:f,line:n,circle:o,rectangle:p}}),define("colorPicker",["jquery","spectrum"],function(a){var b=function(){a("#picker").spectrum({color:"#ffffff"})};return{init:b}}),define("menu",["jquery","colorPicker"],function(a,b){b.init();var c={selected:"pen"},d=[{id:"pen"},{id:"circle"},{id:"rectangle"},{id:"line"},{id:"eraser"},{id:"collaboration"}],e=function(a){this.selected=a.currentTarget.id},f=function(){for(var b=0;b<d.length;b++){var f=d[b];a("#"+f.id).click(a.proxy(e,c))}};return{menu:d,init:f,tool:c,setSelectedTool:e}});